<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Lynx Apartment Host Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
        background: #f9f9f9;
      }
      h1 {
        text-align: center;
      }
      .tabs {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
        gap: 0;
      }
      .tab-btn {
        background: none;
        border: none;
        outline: none;
        padding: 12px 24px;
        font-size: 16px;
        cursor: pointer;
        border-bottom: 3px solid #ccc;
        transition: border 0.2s, color 0.2s;
        white-space: nowrap;
        flex: 1 1 auto;
        text-align: center;
        min-width: 120px;
        max-width: 100vw;
      }
      .tab-btn.active {
        border-bottom: 3px solid #0078d7;
        color: #0078d7;
        font-weight: bold;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .section {
        margin-bottom: 30px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input[type="text"] {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
      }
      .checkbox-group {
        margin-left: 20px;
      }
      .checkbox-group label {
        font-weight: normal;
        display: block;
        margin-bottom: 5px;
      }
      button {
        padding: 10px 20px;
        margin-top: 20px;
      }
      .add-btn {
        margin-top: 10px;
        font-size: 12px;
      }
      img.logo {
        display: block;
        margin: auto;
        width: 100px;
      }
      @media screen and (max-width: 600px) {
        .tabs {
          flex-direction: row;
          flex-wrap: wrap;
        }
        .tab-btn {
          font-size: 15px;
          padding: 10px 8px;
          min-width: 100px;
        }
        .checkbox-group label {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 5px 0;
        }
        .checkbox-group input[type="checkbox"] {
          margin-right: 10px;
        }
      }
      body.dark-mode {
        background: #23272a;
        color: #f3f3f3;
      }
      body.dark-mode h1,
      body.dark-mode label {
        color: #f3f3f3;
      }
      body.dark-mode .container {
        background: #23272a;
      }
      body.dark-mode .tab-btn.active {
        color: #ffe066;
        border-bottom: 3px solid #ffe066;
      }
      body.dark-mode .tab-content {
        background: transparent;
      }
      body.dark-mode button,
      body.dark-mode .add-btn {
        background: #23272a;
        color: #ffe066;
        border: 1px solid #ffe066;
      }
      body.dark-mode input[type="text"] {
        background: #23272a;
        color: #f3f3f3;
        border: 1px solid #444;
      }
      body.dark-mode .checkbox-group label {
        color: #f3f3f3;
      }
      body.dark-mode #shopping-list li {
        color: #f3f3f3;
      }
      body.dark-mode select {
        background: #23272a;
        color: #f3f3f3;
        border: 1px solid #444;
      }
      body.dark-mode .tab-btn {
        border: none; /* спречува несакаен оквир */
        border-bottom: 3px solid #444; /* само долниот раб ако сакате */
        background: transparent;
      }
      /* --- Responsive Top Bar for Date & Theme Toggle --- */
      .top-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 20px;
        padding: 0 16px;
        position: relative;
      }
      .top-bar label {
        margin: 0;
        font-weight: 600;
        font-size: 1rem;
        white-space: nowrap;
        margin-right: 8px;
      }
      .top-bar select {
        width: fit-content;
        font-size: 1rem;
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: #fff;
        color: #23272a;
        margin: 0 8px;
      }
      #theme-toggle {
        position: absolute;
        top: 16px;
        right: 16px;
        font-size: 1.5rem;
        background: none;
        border: none;
        cursor: pointer;
        border-radius: 4px;
        padding: 4px 8px;
      }
      .top-bar button#theme-toggle {
        font-size: 1.6em;
        background: none;
        border: none;
        cursor: pointer;
        border-radius: 50%;
        padding: 6px 10px;
        transition: background 0.2s;
        margin: 0;
      }
      .top-bar button#theme-toggle:active,
      .top-bar button#theme-toggle:focus {
        background: #eee;
        outline: none;
      }

      @media (max-width: 600px) {
        .top-bar {
          flex-direction: column;
          align-items: stretch;
          gap: 8px;
          padding: 12px;
        }
        .top-bar label,
        .top-bar select,
        .top-bar button#theme-toggle {
          font-size: 1.08em;
          width: 100%;
          margin: 0;
          text-align: center;
        }

        .top-bar button#theme-toggle {
          align-self: flex-end;
          width: auto;
        }
      }
      body.dark-mode .top-bar select {
        width: fit-content;
        background: #23272a;
        color: #f3f3f3;
        border: 1px solid #444;
      }
      body.dark-mode .top-bar button#theme-toggle:active,
      body.dark-mode .top-bar button#theme-toggle:focus {
        background: #333;
      }
      #theme-toggle {
        position: absolute;
        top: 16px;
        right: 16px;
        font-size: 1.5rem;
        background: #f0f0f0;
        color: #222;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        z-index: 1000;
      }
      body.dark-mode #theme-toggle {
        background: #23272a;
        color: #ffe066;
        border-color: #23272a;
      }
      #theme-toggle:hover {
        background: transparent;
      }
      .date-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }
      .date-wrapper select {
        width: fit-content;
        padding: 6px 10px;
        font-size: 1rem;
        margin-bottom: 16px;
        border-color: #cbd2d7;
      }

      .date-row select {
        width: fit-content;
        min-width: auto;
        padding: 6px 10px;
        font-size: 1rem;
      }
      body.dark-mode .date-wrapper select {
        background: #23272a;
        color: #f3f3f3;
        border: 1px solid #444;
        width: fit-content;
        margin-bottom: 16px;
      }
      /* New styles for enhanced UI */
      .sticky-tabs {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1000;
        padding: 10px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      body.dark-mode .sticky-tabs {
        background: #23272a;
      }
      .accordion {
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
      }
      .accordion-header {
        background: #f5f5f5;
        padding: 12px 15px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 4px;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      .accordion-header:hover {
        background: #eee;
      }
      .accordion-content {
        padding: 15px;
        display: none;
      }
      .accordion.active .accordion-content {
        display: block;
      }
      .progress-bar {
        height: 4px;
        background: #eee;
        border-radius: 2px;
        margin: 5px 0;
      }
      .progress-fill {
        height: 100%;
        background: #0078d7;
        border-radius: 2px;
        transition: width 0.3s ease;
      }
      .search-container {
        margin: 20px 0;
        position: relative;
        width: fit-content;
        margin: 0 auto 20px auto;
      }
      .search-input {
        width: 200px;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }
      .priority-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
        margin-left: 8px;
      }
      .priority-high {
        background: #ffebee;
        color: #c62828;
      }
      .priority-medium {
        background: #fff3e0;
        color: #ef6c00;
      }
      .priority-low {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .item-metadata {
        font-size: 12px;
        color: #666;
        margin-left: 8px;
      }
      .view-all-btn {
        background: none;
        border: none;
        color: #0078d7;
        cursor: pointer;
        padding: 5px 10px;
        font-size: 14px;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .section-stats {
        font-size: 14px;
        color: #666;
      }
      /* Dark mode adjustments */
      body.dark-mode .accordion-header {
        background: #2c2f33;
        color: #fff;
      }
      body.dark-mode .accordion-header:hover {
        background: #36393f;
      }
      body.dark-mode .search-input {
        background: #2c2f33;
        color: #fff;
        border-color: #444;
      }
      body.dark-mode .priority-badge {
        opacity: 0.9;
      }
      body.dark-mode .item-metadata {
        color: #aaa;
      }
      body.dark-mode .view-all-btn {
        color: #ffe066;
      }
      body.dark-mode .section-stats {
        color: #aaa;
      }
      /* Mobile optimizations */
      @media screen and (max-width: 600px) {
        body {
          margin: 20px 10px;
        }
        .accordion-header {
          padding: 10px;
        }
        .search-input {
          font-size: 16px; /* Prevents zoom on iOS */
        }
        .priority-badge {
          font-size: 11px;
        }
      }
      /* Make checkboxes more touch-friendly */
      .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        cursor: pointer;
      }
      .checkbox-group label {
        padding: 8px 0;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }

      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #28a745; /* Зелена боја за успешна операција */
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 14px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s, visibility 0.5s ease-in-out;
        z-index: 9999;
      }

      .toast.show {
        opacity: 1;
        visibility: visible;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button id="theme-toggle" aria-label="Toggle dark mode">🌙</button>

      <div class="date-wrapper">
        <label for="date">Датум на инспекција:</label>
        <select id="date"></select>
      </div>

      <img src="logo-lynx.png" alt="Lynx Logo" class="logo" id="lynx-logo" />
      <h1>Lynx Apartment Dashboard</h1>

      <!-- Search Container -->
      <div class="search-container">
        <input type="text" class="search-input" id="search-input" placeholder="Search items..." />
      </div>

      <!-- Sticky Tabs -->
      <nav class="tabs sticky-tabs" role="tablist">
        <button
          class="tab-btn active"
          id="tab-checklist"
          role="tab"
          aria-selected="true"
          aria-controls="content-checklist"
          tabindex="0"
        >
          Чистење
        </button>
        <button
          class="tab-btn"
          id="tab-consumables"
          role="tab"
          aria-selected="false"
          aria-controls="content-consumables"
          tabindex="-1"
        >
          Потрошан Материјал
        </button>
        <button
          class="tab-btn"
          id="tab-inventory"
          role="tab"
          aria-selected="false"
          aria-controls="content-inventory"
          tabindex="-1"
        >
          Инвентура
        </button>
        <button
          class="tab-btn"
          id="tab-shopping"
          role="tab"
          aria-selected="false"
          aria-controls="content-shopping"
          tabindex="-1"
        >
          Шопинг листа
        </button>
      </nav>

      <!-- Cleaning List Section -->
      <div
        id="content-checklist"
        class="tab-content active"
        role="tabpanel"
        aria-labelledby="tab-checklist"
      >
        <div id="checklist-sections">
          <!-- Cleaning checklist items will be rendered here -->
        </div>
        <div class="section">
          <label>Additional Notes</label>
          <input type="text" id="notes" placeholder="Any extra details..." />
        </div>
      </div>
      <!-- Consumables List Section -->
      <div
        id="content-consumables"
        class="tab-content"
        role="tabpanel"
        aria-labelledby="tab-consumables"
      >
        <div id="consumables-sections"><!-- Consumables items rendered here --></div>
      </div>
      <!-- Inventory List Section -->
      <div
        id="content-inventory"
        class="tab-content"
        role="tabpanel"
        aria-labelledby="tab-inventory"
      >
        <div id="inventory-sections"><!-- Inventory items rendered here --></div>
      </div>
      <!-- Shopping List Section -->
      <div id="content-shopping" class="tab-content" role="tabpanel" aria-labelledby="tab-shopping">
        <div class="section">
          <ul
            id="shopping-list"
            class="checkbox-group"
            style="list-style: none; padding-left: 0"
          ></ul>
          <button class="add-btn" onclick="addShoppingItem()">+ Додади ставка</button>
        </div>
      </div>
      <!-- Global Save Checklist Button -->
      <div style="text-align: center; margin: 32px 0 0 0">
        <button id="save-checklist-global" onclick="saveChecklist()">Зачувај листа</button>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="DejaVuSans-normal.js"></script>
    <script>
      // --- Tab Switching & Theme Logic ---
      const tabBtns = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");

      // Track active tab
      let activeTab = "tab-checklist"; // Default to Cleaning tab

      tabBtns.forEach((btn, idx) => {
        btn.addEventListener("click", function () {
          tabBtns.forEach(b => b.classList.remove("active"));
          tabContents.forEach(c => c.classList.remove("active"));
          btn.classList.add("active");
          tabContents[idx].classList.add("active");

          // Update active tab
          activeTab = btn.id; // Store the current active tab
          updateAddToShoppingBtnVisibility(); // Call function to update button visibility

          btn.setAttribute("aria-selected", "true");
          btn.setAttribute("tabindex", "0");
          tabBtns.forEach((b, i) => {
            if (i !== idx) {
              b.setAttribute("aria-selected", "false");
              b.setAttribute("tabindex", "-1");
            }
          });
        });
      });

      function updateAddToShoppingBtnVisibility() {
        // Hide all "Add to Shopping" buttons initially
        const addToShoppingBtns = document.querySelectorAll(".add-to-shopping-btn");
        addToShoppingBtns.forEach(btn => {
          btn.style.display = "none"; // Hide button by default
        });

        // Show the buttons only in the "tab-inventory" tab
        if (activeTab === "tab-consumables") {
          const inventoryBtns = document.querySelectorAll(".add-to-shopping-btn");
          inventoryBtns.forEach(btn => {
            btn.style.display = "inline-block"; // Show button in inventory tab
          });
        }
      }

      // --- Dark Mode Logic ---
      const themeToggle = document.getElementById("theme-toggle");
      const logoImg = document.getElementById("lynx-logo");
      function setTheme(dark) {
        if (dark) {
          document.body.classList.add("dark-mode");
          themeToggle.textContent = "☀️";
          logoImg.src = "logo-lynx-dark.png";
          localStorage.setItem("lynx-theme", "dark");
        } else {
          document.body.classList.remove("dark-mode");
          themeToggle.textContent = "🌙";
          logoImg.src = "logo-lynx.png";
          localStorage.setItem("lynx-theme", "light");
        }
      }
      themeToggle.onclick = function () {
        setTheme(!document.body.classList.contains("dark-mode"));
      };
      (function () {
        const saved = localStorage.getItem("lynx-theme");
        setTheme(saved === "dark");
      })();

      // --- Enhanced Section Grouping & Metadata ---
      // Define metadata for items (priority, estimated time, frequency)
      const itemMetadata = {
        // Example: 'Отвори врата - проветри': { priority: 'high', time: 1, frequency: 'every stay' }
      };
      // Grouped sections for accordions
      const CleaningGroups = [
        {
          group: "Соби",
          sections: ["Општо", "Спална", "Дневна"],
        },
        {
          group: "Кујна",
          sections: ["Кујна", "Трпезарија"],
        },
        {
          group: "Купатило",
          sections: ["Купатило"],
        },
        {
          group: "Останато",
          sections: ["Тераса", "Ходник"],
        },
      ];
      // --- Cleaning List Logic (refactored for accordions, progress, view all) ---
      const CleaningSections = {
        Општо: [
          "Проветри - отвори врата",
          "Собери постелнина и крпе (спална, кујна, WC)",
          "Собери ѓубре (кујна и WC)",
          "Истреси прекривачи/кебиња/јастуци (дневна/спална)",
          "Усисај теписи, подови, гарнитура, столице",
          "Избриши прашина од површини",
          "Изџогирај под",
          "Провери да нема заборавени предмети/храна",
          "Исчисти прекидачи за светла и ручке на врата",
          "Провери сите фиоки и висаќи",
        ],
        Спална: [
          "Избриши прашина од ноќни ормари/лампе/ТВ",
          "Провери ТВ и далечински",
          "Избриши прашина во гардеробер",
          "Провери кревет и душек",
          "Провери резервна постелнина под кревет",
        ],
        Дневна: [
          "Избриши и провери ТВ, далечински и комоду",
          "Избриши прашина од минибар",
          "Избриши прашина од Лустер/Столна Лампа",
          "Провери sofa bed",
          "Наводни цвеќе",
          "Провери WiFi брзина",
          "Провери книги за Македонија (3)",
        ],
        Кујна: [
          "Избриши шпорет и рерну",
          "Испразни и Избриши фрижидер и замрзнувач",
          "Испразни и Избриши машина за кафе",
          "Избриши микробранова печка",
          "Провери машина за садови",
          "Исчисти електричен бокал",
          "Испразни тостер од трошке",
          "Провери тенџериња и тави",
          "Избриши прибор за јадење",
          "Избриши стакленки чаши",
          "Избриши даски за сечење",
          "Дополни чај/кафе/бомбоне/вода",
          "Дополни кесе за ѓубре",
        ],
        Купатило: [
          "Исчисти огледало и лавабо",
          "Исчисти туш кабина и туш ручка",
          "Исчисти ВЦ шоља и Четка за ВЦ шоља",
          "Изџогирај под и плочки",
          "Дополни тоалетна хартија",
          "Дополни течен сапунн",
          "Дополни средство за перење алишта",
          "Дополни средство за дезинфекција",
          "Замени освеживач за ВЦ шоља",
          "Стави нови крпи (капење, лице, ноге) (2 по госта)",
          "Провери фен, машина за прање, бојлер, сушара",
        ],
        Трпезарија: [
          "Пребриши трпезариски астал",
          "Истреси столици од трошки",
          "Намести подлоги за вруќо",
          "Стави вазну на сред стал",
        ],
        Тераса: ["Измиј тераса", "Пребриши асталче и столици"],
        Ходник: ["Пребриши плакар", "Пребриши Огледало"],
      };
      // Save/load checked state to localStorage
      function getCheckedState(section) {
        return JSON.parse(localStorage.getItem("checked_" + section) || "[]");
      }
      function setCheckedState(section, arr) {
        localStorage.setItem("checked_" + section, JSON.stringify(arr));
      }
      // Section with progress bar
      function renderSectionWithProgress(title, items, sectionKey, onProgressChange) {
        const sectionDiv = document.createElement("div");
        sectionDiv.className = "section";

        // Section header
        const header = document.createElement("div");
        header.className = "section-header";
        header.innerHTML = `<label>${title}</label>`;
        sectionDiv.appendChild(header);

        // Items list
        const ul = document.createElement("div");
        ul.className = "checkbox-group section-items";

        // Load checked state from localStorage
        let checkedArr = JSON.parse(localStorage.getItem("checked_" + sectionKey) || "[]");
        if (!Array.isArray(checkedArr) || checkedArr.length !== items.length) {
          checkedArr = Array(items.length).fill(false);
        }

        items.forEach((item, idx) => {
          const label = document.createElement("label");
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.justifyContent = "space-between";
          // Fix: Always display correct item text
          let displayText = "";
          if (typeof item === "string") {
            displayText = item;
          } else if (item && typeof item === "object") {
            displayText = item.text || item.name || JSON.stringify(item);
          }

          // Conditionally add the "add-to-shopping-btn" button
          const addToShoppingBtn =
            activeTab === "tab-consumables"
              ? `<button class="add-to-shopping-btn" data-item="${item}" onclick="addToShoppingList('${item}')">🛒</button>`
              : "";

          label.innerHTML = `<span><input type="checkbox" data-section="${sectionKey}" data-idx="${idx}"> ${displayText}</span>`;
          const checkbox = label.querySelector("input[type='checkbox']");
          checkbox.checked = checkedArr[idx];
          checkbox.onchange = function () {
            checkedArr[idx] = checkbox.checked;
            localStorage.setItem("checked_" + sectionKey, JSON.stringify(checkedArr));
            if (onProgressChange) {
              onProgressChange();
            }
          };
          ul.appendChild(label);
        });

        sectionDiv.appendChild(ul);

        // Make header clickable for collapse/expand
        header.onclick = function (e) {
          if (e.target.tagName === "INPUT") return;
          ul.style.display = ul.style.display === "none" ? "block" : "none";
        };

        return sectionDiv;
      }

      // Accordion rendering
      function renderCleaningAccordions() {
        const container = document.getElementById("checklist-sections");
        container.innerHTML = "";

        // Add collapse/expand all button
        const controlsDiv = document.createElement("div");
        controlsDiv.className = "section-controls";
        controlsDiv.innerHTML = `
          <button class="view-all-btn" onclick="toggleAllSections(true)">Expand All</button>
          <button class="view-all-btn" onclick="toggleAllSections(false)">Collapse All</button>
        `;
        container.appendChild(controlsDiv);

        CleaningGroups.forEach(groupObj => {
          const acc = document.createElement("div");
          acc.className = "accordion";

          const header = document.createElement("div");
          header.className = "accordion-header";

          // Calculate total items and completed items for this group
          let totalItems = 0;
          let completedItems = 0;
          groupObj.sections.forEach(section => {
            const items = CleaningSections[section];
            totalItems += items.length;
            const checkedArr = JSON.parse(localStorage.getItem("checked_" + section) || "[]");
            if (Array.isArray(checkedArr)) {
              completedItems += checkedArr.filter(Boolean).length;
            }
          });

          header.innerHTML = `
            <span>${groupObj.group}</span>
            <span class="section-stats">${completedItems}/${totalItems} завршено</span>
          `;
          acc.appendChild(header);

          const content = document.createElement("div");
          content.className = "accordion-content";

          groupObj.sections.forEach(section => {
            content.appendChild(
              renderSectionWithProgress(section, CleaningSections[section], section, () => {
                // Update group progress when any item changes
                let newTotal = 0;
                let newCompleted = 0;
                groupObj.sections.forEach(s => {
                  const items = CleaningSections[s];
                  newTotal += items.length;
                  const checkedArr = JSON.parse(localStorage.getItem("checked_" + s) || "[]");
                  if (Array.isArray(checkedArr)) {
                    newCompleted += checkedArr.filter(Boolean).length;
                  }
                });
                header.querySelector(
                  ".section-stats"
                ).textContent = `${newCompleted}/${newTotal} завршено`;
              })
            );
          });

          acc.appendChild(content);
          container.appendChild(acc);

          // Accordion toggle
          header.onclick = function (e) {
            if (e.target.tagName === "INPUT") return;
            acc.classList.toggle("active");
            content.style.display = content.style.display === "none" ? "block" : "none";
          };
        });
      }

      // Toggle all sections
      function toggleAllSections(expand) {
        document.querySelectorAll(".accordion-content").forEach(content => {
          content.style.display = expand ? "block" : "none";
        });
        document.querySelectorAll(".accordion").forEach(acc => {
          acc.classList.toggle("active", expand);
        });
      }

      // --- Search/Filter Logic ---
      document.getElementById("search-input").addEventListener("input", function (e) {
        const val = e.target.value.toLowerCase();
        document.querySelectorAll(".section-items label").forEach(label => {
          const text = label.textContent.toLowerCase();
          label.style.display = text.includes(val) ? "flex" : "none";
        });
      });

      // --- Initial Render on Load ---
      window.onload = function () {
        populateDateDropdown();
        renderCleaningAccordions();
        renderConsumablesAccordions();
        renderInventoryFilterDropdown();
        renderInventoryAccordions();
        renderShoppingList();
        // Load saved notes
        const savedNotes = localStorage.getItem("notes");
        if (savedNotes) {
          document.getElementById("notes").value = savedNotes;
        }
      };
      function populateDateDropdown() {
        const select = document.getElementById("date");
        const today = new Date();
        for (let i = 0; i < 7; i++) {
          const d = new Date(today);
          d.setDate(today.getDate() + i);
          const dd = String(d.getDate()).padStart(2, "0");
          const mm = String(d.getMonth() + 1).padStart(2, "0");
          const yyyy = d.getFullYear();
          const dateStr = `${dd}-${mm}-${yyyy}`;
          const option = document.createElement("option");
          option.value = dateStr;
          option.text = dateStr;
          if (i === 0) option.selected = true;
          select.appendChild(option);
        }
      }
      function saveChecklist() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Register and set DejaVu font for Cyrillic support
        try {
          doc.addFileToVFS("DejaVuSans.ttf", dejavu_sans_normal);
          doc.addFont("DejaVuSans.ttf", "DejaVu", "normal");
          doc.setFont("DejaVu");
        } catch (e) {
          console.error("Font loading error:", e);
          doc.setFont("Tahoma");
        }

        doc.setFontSize(16);
        let y = 10;

        // --- Cleaning List ---
        doc.text("Cleaning List", 10, y);
        y += 10;
        doc.setFontSize(12);
        for (const [section, items] of Object.entries(CleaningSections)) {
          doc.text(section, 10, y);
          y += 8;
          const checkedArr = JSON.parse(localStorage.getItem("checked_" + section) || "[]");
          items.forEach((item, idx) => {
            const checked = checkedArr[idx];
            const text = "[" + (checked ? "x" : " ") + "] " + item;
            doc.text(text, 14, y);
            y += 7;
            if (y > 280) {
              doc.addPage();
              y = 10;
            }
          });
          y += 4;
        }

        // Notes
        const notes = document.getElementById("notes").value;
        if (notes) {
          doc.text("Notes:", 10, y);
          y += 7;
          doc.text(notes, 10, y);
        }

        doc.addPage();
        y = 10;

        // --- Consumables List ---
        doc.setFontSize(16);
        doc.text("Consumables List", 10, y);
        y += 10;
        doc.setFontSize(12);
        for (const [section, items] of Object.entries(ConsumablesSections)) {
          doc.text(section, 10, y);
          y += 8;
          const checkedArr = JSON.parse(localStorage.getItem("checked_" + section) || "[]");
          items.forEach((item, idx) => {
            const checked = checkedArr[idx];
            const text = "[" + (checked ? "x" : " ") + "] " + item;
            doc.text(text, 14, y);
            y += 7;
            if (y > 280) {
              doc.addPage();
              y = 10;
            }
          });
          y += 4;
        }

        doc.addPage();
        y = 10;

        // --- Inventory List ---
        doc.setFontSize(16);
        doc.text("Inventory List", 10, y);
        y += 10;
        doc.setFontSize(12);
        for (const [section, items] of Object.entries(InventorySections)) {
          doc.text(section, 10, y);
          y += 8;
          const checkedArr = JSON.parse(localStorage.getItem("checked_" + section) || "[]");
          items.forEach((item, idx) => {
            // item is now an object: {text, type}
            const checked = checkedArr[idx];
            const text = "[" + (checked ? "x" : " ") + "] " + item.text + " (" + item.type + ")";
            doc.text(text, 14, y);
            y += 7;
            if (y > 280) {
              doc.addPage();
              y = 10;
            }
          });
          y += 4;
        }

        // --- Shopping List ---
        doc.setFontSize(16);
        doc.text("Shopping List", 10, y);
        y += 10;
        doc.setFontSize(12);

        const shoppingUl = document.getElementById("shopping-list");
        if (shoppingUl) {
          const lis = shoppingUl.querySelectorAll("li");
          lis.forEach(li => {
            const cb = li.querySelector("input[type='checkbox']");
            const checked = cb && cb.checked;
            const text = "[" + (checked ? "x" : " ") + "] " + li.innerText.trim();
            doc.text(text, 14, y);
            y += 7;
            if (y > 280) {
              doc.addPage();
              y = 10;
            }
          });
        }

        // --- Save PDF ---
        const date = document.getElementById("date").value;
        doc.save("Lynx_Checklist_" + date + ".pdf");
      }

      // --- Consumables List Logic ---
      const ConsumablesGroups = [
        {
          group: "Потрошен материјал за во Кујна",
          sections: ["Кујна"],
        },
        {
          group: "Потрошен материјал за во Купатило",
          sections: ["Купатило"],
        },
        {
          group: "Останато",
          sections: ["Дневна", "Минибар", "Ходник"],
        },
      ];

      const ConsumablesSections = {
        Кујна: [
          "Сјај за судови, сунгерчиња",
          "Средства за чистење (Професионално, ДеГрас, Плотна)",
          "Таблети за машина за миење садови",
          "Кеси за ѓубре",
          "Брисачи (ролна хартија)",
          "Крпи за прашина (Виледа и памучни)",
          "Сол, шеќер, масло, оцат, зачини",
          "Кафе/Чај/Бомбони/Вода",

        ],
        Купатило: [
          "Тоалет хартија",
          "Сапун за раце (Течен + еднократни)",
          "Четкица и паста за зуби (еднократни)",
          "Памучни туфери",
          "Памучни стапчиња",
          "Освежувачи за воздух",
          "Средство за дезинфекција",
          "Средство за ВЦ шоља (освеживач)",
          "Средство/Таблети за перење алишта",
          "Средство против каменац",
          "Ракавици за чистење",
        ],
        Дневна: ["Батерие за даљинско", "Сијалици за Лустер", "Сијалица за Столна лампа"],
        Минибар: [
          "5 Вина (700ml секое)",
          "5 Жестоки пијалоци (50ml секое)",
          "5 Грицки (чипс, јаткасти плодови итн.)",
          "2 Чоколада (50g секое)",
        ],
        Ходник: ["Боја за ципеле (2)", "Ролер за чистење влакна (1)"],
      };

      // --- Inventory List Logic ---
      const InventoryGroups = [
        {
          group: "Соби",
          sections: ["Дневна Инвентура", "Спална Инвентура"],
        },
        {
          group: "Кујна и Трпезарија",
          sections: ["Кујна Инвентура", "Трпезарија Инвентура"],
        },

        {
          group: "Купатило",
          sections: ["Купатило Инвентура"],
        },
        {
          group: "Останато",
          sections: ["Ходник Инвентура", "Тераса Инвентура"],
        },
      ];

      // Inventory items now have type: 'E' (Essential) or 'O' (Optional)
      const InventorySections = {
        "Дневна Инвентура": [
          { text: "Столна лампа (1) (IKEA: 30405042)", type: "E" },
          { text: "Перници, бели/тврди, 50x50 см (2)(IKEA: 50550702)", type: "E" },
          { text: "Покривка на гарнитура (2)", type: "O" },
          { text: "Уметничка слика на ѕид (1)", type: "O" },
          { text: "Подлога за маса, воден зумбул, 37 см (1) (IKEA: 40082536)", type: "O" },
          { text: "Computer Mouse (1)", type: "O" },
          { text: "HDMI кабел (1)", type: "O" },
          { text: "US to EU адаптер (2)", type: "O" },
          { text: "Продужан кабал (1)", type: "O" },
          { text: "Книги за Македонија (3)", type: "O" },
          { text: "Украси на сталажа десно", type: "O" },
          { text: "Свеќи на батерија (2)", type: "O" },
          { text: "Кошница за цвеќе, морска трева, 25см (1) (IKEA: 60322173)", type: "O" },
        ],
        "Кујна Инвентура": [
          { text: "Нож, 3 ком (IKEA: 70257624)", type: "E" },
          { text: "Нож, црн 22 цм (4)(IKEA: 00287295)", type: "E" },
          { text: "Даска за сечење, бамбус, 45x28 см (IKEA: 80233430)", type: "E" },
          { text: "Острилка за ножеви, црна (IKEA: 57145296)", type: "O" },
          { text: "Лупалка за компири, зелена (IKEA: 90521963)", type: "O" },
          { text: "Здела за салата, проѕирно стакло, 20 см (IKEA: 90057252)", type: "O" },
          {
            text: "Прибор за јадење, 30 парчиња, од не'рѓосувачки челик (IKEA: 30167507)",
            type: "E",
          },
          { text: "Тенџере за готвење со капак (3), тигањ (1)(IKEA: 80580104)", type: "E" },
          { text: "Подметач за тенџере, плута, 19 см (IKEA: 87077700)", type: "O" },
          { text: "Држач за вруќо тенџере, сив, 21x21 см (IKEA: 00476366)", type: "O" },
          { text: "Сад за сол/бибер, проѕирно стакло 8см ( IKEA: 40553211)", type: "O" },
          { text: "Кујнски крпи, бел/зелен/со шари, 45x60 см (4)(IKEA: 60476354)", type: "E" },
          { text: "Кујнски крпи, бел/темно сив/со шари, 45x60 см (8)(IKEA: 20476346)", type: "E" },
          { text: "Полица цедење за садови (1)(IKEA: 80461276)", type: "O" },
          { text: "Жица за матење, тркалезна (1)(IKEA: 10225952)", type: "O" },
          {
            text: "Организер за прибор за јадење, светла бамбусова, 52x50 см (IKEA: 70433104)",
            type: "O",
          },
          { text: "Ренде", type: "O" },
          { text: "Тостер, црн", type: "O" },
          { text: "Бокал за воду на струја", type: "O" },
          { text: "Кафемат KRUPS KP 243B10, 1000W, 15 bar", type: "O" },
          { text: "Здела за капсуле за кафе (Temu)", type: "O" },
        ],
        "Трпезарија Инвентура": [
          { text: "Подлога за маса, темно сива, 38x30см (4) (IKEA: 20569251)", type: "O" },
          { text: "Вазна, проѕирно стакло во боја", type: "O" },
          { text: "Трпезариска маса со 4 столици", type: "E" },
        ],
        "Спална Инвентура": [
          { text: "Офингер (8) (IKEA: 30238543)", type: "E" },
          { text: "Водоотпорен заштитник за душек, 160x200 см (2) (IKEA: 60522129)", type: "E" },
          {
            text: "Навлака за јорган и 2 навлаки за перници, сива/пругаста, 200x200/50x60см (2) (IKEA: 70423242)",
            type: "E",
          },
          {
            text: "Навлака за јорган и 2 навлаки за перници, бела, 200x200/50x60 см (1) (IKEA: 20377959)",
            type: "E",
          },
          { text: "Чаршаф, бела, 160x200 см (3) (IKEA: 30357220)", type: "E" },
          { text: "Јорган за сите сезони, 200x200 см (1+1) (IKEA: 70458585)", type: "E" },
          { text: "Навлака за перница, светло сива, 50x60 см (1) (IKEA: 90482476)", type: "O" },
          { text: "Навлака за перница, бела, 50x60 см (3) (IKEA: 10357301)", type: "O" },
          { text: "Перница, висока, 50x60 см (2) (IKEA: 20460411)", type: "E" },
          { text: "Перница, ниска, на стомак, 50x60 см (2) (IKEA: 50460546)", type: "O" },
          { text: "Столна ламба, пепел/бела (2) (IKEA: 60573538)", type: "O" },
          { text: "Малечка ламба за читање (1)", type: "O" },
          { text: "Даска за пеглање", type: "O" },
          { text: "Пегла", type: "O" },
          { text: "Прекривач/кебе, темно сива, 230x250см (1) (IKEA: 60346447)", type: "O" },
          { text: "Кебе тенко (1)", type: "O" },
          { text: "Кебе дебело (1)", type: "O" },
          { text: "Кревет за деца (Ѓоре)", type: "O" },
          { text: "Навлака за сако (1)", type: "O" },
        ],
        "Купатило Инвентура": [
          { text: "Саксија за цвеќе (IKEA: 40395617)", type: "O" },
          { text: "Канта за отпад (IKEA: 20593736)", type: "E" },
          { text: "Четка за тоалет (IKEA: 10593727)", type: "E" },
          { text: "Држач за тоалетна хартија (IKEA: 40381291)", type: "E" },
          { text: "Крпа за бањање, (6), 70x140 см (IKEA: 80350985)", type: "E" },
          { text: "Крпа за руке, (6), 50x100 см (IKEA: 70350995)", type: "E" },
          { text: "Туш ручка (IKEA: 60342543)", type: "O" },
          { text: "Тепих за бању, тиркизна, 50x80 см (IKEA: 40603169)", type: "O" },
          { text: "Дозатор за сапун (IKEA: 30593726)", type: "O" },
          { text: "Држач за четкице за зуби (IKEA: 50593730)", type: "O" },
          { text: "Самолеплива кука (2) (IKEA: 50567830)", type: "O" },
          { text: "Надворешни полици за крпе, бамбус, 37x37x104см (1)(IKEA: 80549420)", type: "O" },
          { text: "Кутија за прва помош Praxis – JUS 5015", type: "E" },
          { text: "Корпа за фен (STOREAGE)", type: "O" },
          { text: "Фен за косу (MAX HD22IR)", type: "O" },
          { text: "Торба за фен (Temu)", type: "O" },
          { text: "Пластична корпа за веш (Temu)", type: "O" },
          { text: "Гумени папуче (Temu)", type: "O" },
          { text: "Прва помош кутија", type: "E" },
        ],
        "Ходник Инвентура": [
          { text: "Подлога за ципеле 71x35 см(IKEA: 60329711)", type: "O" },
          { text: "Усисувач (MAKS VC 2200SW)", type: "E" },
          { text: "Кашика за ципеле", type: "O" },
        ],
        "Тераса Инвентура": [
          { text: "Столица за седење (2)(IKEA: 90095428)", type: "O" },
          { text: "Асталче за терасу (1)(IKEA: 70095429)", type: "O" },
        ],
      };

      // --- Inventory Filter Dropdown ---
      let inventoryFilter = "all"; // 'all', 'E', 'O'

      function renderInventoryFilterDropdown() {
        const container = document.getElementById("inventory-sections");
        let filterDiv = document.getElementById("inventory-filter-div");
        if (!filterDiv) {
          filterDiv = document.createElement("div");
          filterDiv.id = "inventory-filter-div";
          filterDiv.style.marginBottom = "10px";
          filterDiv.innerHTML = `
            <select id="inventory-filter" class="view-all-btn" style="width:auto;">
              <option value="all">Сите</option>
              <option value="E">Само Essentials</option>
              <option value="O">Само Optional</option>
            </select>
          `;
          container.parentNode.insertBefore(filterDiv, container);
          document.getElementById("inventory-filter").addEventListener("change", function (e) {
            inventoryFilter = e.target.value;
            renderInventoryAccordions();
          });
        }
      }

      // --- Inventory Accordion Rendering ---
      function renderInventoryAccordions() {
        const container = document.getElementById("inventory-sections");
        // Remove all except filter dropdown
        container
          .querySelectorAll(".accordion, .section-controls, .section")
          .forEach(e => e.remove());

        InventoryGroups.forEach(groupObj => {
          const acc = document.createElement("div");
          acc.className = "accordion";

          const header = document.createElement("div");
          header.className = "accordion-header";

          // Calculate total and completed items for this group (respecting filter)
          let totalItems = 0;
          let completedItems = 0;
          groupObj.sections.forEach(section => {
            const items = InventorySections[section];
            let filteredItems = items;
            if (inventoryFilter === "E") filteredItems = items.filter(i => i.type === "E");
            if (inventoryFilter === "O") filteredItems = items.filter(i => i.type === "O");
            totalItems += filteredItems.length;
            const checkedArr = JSON.parse(localStorage.getItem("checked_" + section) || "[]");
            if (Array.isArray(checkedArr)) {
              filteredItems.forEach((item, idx) => {
                // Find the index of this item in the original items array
                const origIdx = items.indexOf(item);
                if (checkedArr[origIdx]) completedItems++;
              });
            }
          });

          header.innerHTML = `
            <span>${groupObj.group}</span>
            <span class="section-stats">${completedItems}/${totalItems} завршено</span>
          `;
          acc.appendChild(header);

          const content = document.createElement("div");
          content.className = "accordion-content";

          groupObj.sections.forEach(section => {
            content.appendChild(
              renderSectionWithProgress(
                section,
                InventorySections[section],
                section,
                () => {
                  // Update group progress when any item changes
                  let newTotal = 0;
                  let newCompleted = 0;
                  groupObj.sections.forEach(s => {
                    const items = InventorySections[s];
                    let filteredItems = items;
                    if (inventoryFilter === "E") filteredItems = items.filter(i => i.type === "E");
                    if (inventoryFilter === "O") filteredItems = items.filter(i => i.type === "O");
                    newTotal += filteredItems.length;
                    const checkedArr = JSON.parse(localStorage.getItem("checked_" + s) || "[]");
                    if (Array.isArray(checkedArr)) {
                      filteredItems.forEach((item, idx) => {
                        const origIdx = items.indexOf(item);
                        if (checkedArr[origIdx]) newCompleted++;
                      });
                    }
                  });
                  header.querySelector(
                    ".section-stats"
                  ).textContent = `${newCompleted}/${newTotal} завршено`;
                },
                true // isInventory
              )
            );
          });

          acc.appendChild(content);
          container.appendChild(acc);

          // Accordion toggle
          header.onclick = function (e) {
            if (e.target.tagName === "INPUT") return;
            acc.classList.toggle("active");
            content.style.display = content.style.display === "none" ? "block" : "none";
          };
        });
      }

      // --- Inventory Section Rendering (with checkboxes and live update) ---
      function renderSectionWithProgress(title, items, sectionKey, onProgressChange, isInventory) {
        const sectionDiv = document.createElement("div");
        sectionDiv.className = "section";

        // Section header
        const header = document.createElement("div");
        header.className = "section-header";
        header.innerHTML = `<label>${title}</label>`;
        sectionDiv.appendChild(header);

        // Items list
        const ul = document.createElement("div");
        ul.className = "checkbox-group section-items";

        // Load checked state from localStorage
        let checkedArr = JSON.parse(localStorage.getItem("checked_" + sectionKey) || "[]");
        if (!Array.isArray(checkedArr) || checkedArr.length !== items.length) {
          checkedArr = Array(items.length).fill(false);
        }

        items.forEach((item, idx) => {
          const label = document.createElement("label");
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.justifyContent = "space-between";
          let itemText = isInventory
            ? `${item.text} <span class='inv-type'>(${
                item.type === "E" ? "Essential" : "Optional"
              })</span>`
            : item;
          label.innerHTML = `<span><input type="checkbox" data-section="${sectionKey}" data-idx="${idx}"> ${itemText}</span>`;
          const checkbox = label.querySelector("input[type='checkbox']");
          checkbox.checked = checkedArr[idx];
          checkbox.onchange = function () {
            checkedArr[idx] = checkbox.checked;
            localStorage.setItem("checked_" + sectionKey, JSON.stringify(checkedArr));
            if (onProgressChange) {
              onProgressChange();
            }
          };
          ul.appendChild(label);
        });

        sectionDiv.appendChild(ul);

        // Make header clickable for collapse/expand
        header.onclick = function (e) {
          if (e.target.tagName === "INPUT") return;
          ul.style.display = ul.style.display === "none" ? "block" : "none";
        };

        return sectionDiv;
      }

      // --- Shopping List Logic ---
      let shoppingList = [];
      let dragSrcIndex = null;
      function renderShoppingList() {
        const ul = document.getElementById("shopping-list");
        ul.innerHTML = "";

        // Load shopping list from localStorage
        shoppingList = JSON.parse(localStorage.getItem("shoppingList") || "[]");

        shoppingList.forEach((item, idx) => {
          const li = document.createElement("li");
          li.setAttribute("draggable", "true");
          li.setAttribute("data-index", idx);
          li.style.display = "flex";
          li.style.alignItems = "center";
          li.style.justifyContent = "space-between";
          li.style.padding = "4px 0";
          li.ondragstart = e => {
            dragSrcIndex = idx;
            e.dataTransfer.effectAllowed = "move";
            li.style.opacity = "0.5";
          };
          li.ondragend = () => {
            li.style.opacity = "";
          };
          li.ondragover = e => {
            e.preventDefault();
            li.style.background = "#e6f7ff";
          };
          li.ondragleave = () => {
            li.style.background = "";
          };
          li.ondrop = e => {
            e.preventDefault();
            li.style.background = "";
            if (dragSrcIndex !== null && dragSrcIndex !== idx) {
              const moved = shoppingList.splice(dragSrcIndex, 1)[0];
              shoppingList.splice(idx, 0, moved);
              renderShoppingList();
            }
            dragSrcIndex = null;
          };
          li.innerHTML = `<span><input type="checkbox"> ${item}</span>`;
          ul.appendChild(li);
        });
      }
      function addShoppingItem() {
        const item = prompt("Enter shopping item:");
        if (item && item.trim() !== "") {
          shoppingList.push(item.trim());
          localStorage.setItem("shoppingList", JSON.stringify(shoppingList)); // Save to localStorage
          renderShoppingList();
        }
      }

      // Add event listener for notes
      document.getElementById("notes").addEventListener("input", function (e) {
        localStorage.setItem("notes", e.target.value);
      });

      // Load notes on page load
      window.onload = function () {
        populateDateDropdown();
        renderCleaningAccordions();
        renderConsumablesAccordions();
        renderInventoryFilterDropdown();
        renderInventoryAccordions();
        renderShoppingList();

        // Load saved notes
        const savedNotes = localStorage.getItem("notes");
        if (savedNotes) {
          document.getElementById("notes").value = savedNotes;
        }
      };

      // Modify the renderConsumablesAccordions function
      function renderConsumablesAccordions() {
        const container = document.getElementById("consumables-sections");
        container.innerHTML = "";

        // Add collapse/expand all button
        const controlsDiv = document.createElement("div");
        controlsDiv.className = "section-controls";
        controlsDiv.innerHTML = `
      <button class="view-all-btn" onclick="toggleAllSections(true)">Expand All</button>
      <button class="view-all-btn" onclick="toggleAllSections(false)">Collapse All</button>
    `;
        container.appendChild(controlsDiv);

        ConsumablesGroups.forEach(groupObj => {
          const acc = document.createElement("div");
          acc.className = "accordion";

          const header = document.createElement("div");
          header.className = "accordion-header";

          // Calculate total items and completed items for this group
          let totalItems = 0;
          let completedItems = 0;
          groupObj.sections.forEach(section => {
            const items = ConsumablesSections[section];
            totalItems += items.length;
            let checkedArr = JSON.parse(localStorage.getItem("checked_" + section) || "[]");
            if (!Array.isArray(checkedArr) || checkedArr.length !== items.length) {
              checkedArr = Array(items.length).fill(false);
            }
            completedItems += checkedArr.filter(Boolean).length;
          });

          header.innerHTML = `
            <span>${groupObj.group}</span>
            <span class="section-stats">${completedItems}/${totalItems} завршено</span>
        `;
          acc.appendChild(header);

          const content = document.createElement("div");
          content.className = "accordion-content";

          groupObj.sections.forEach(section => {
            content.appendChild(
              renderSectionWithProgress(section, ConsumablesSections[section], section, () => {
                // Update group progress when any item changes
                let newTotal = 0;
                let newCompleted = 0;
                groupObj.sections.forEach(s => {
                  const items = ConsumablesSections[s];
                  newTotal += items.length;
                  let checkedArr = JSON.parse(localStorage.getItem("checked_" + s) || "[]");
                  if (!Array.isArray(checkedArr) || checkedArr.length !== items.length) {
                    checkedArr = Array(items.length).fill(false);
                  }
                  newCompleted += checkedArr.filter(Boolean).length;
                });
                header.querySelector(
                  ".section-stats"
                ).textContent = `${newCompleted}/${newTotal} завршено`;
              })
            );
          });

          acc.appendChild(content);
          container.appendChild(acc);

          // Accordion toggle
          header.onclick = function (e) {
            if (e.target.tagName === "INPUT") return;
            acc.classList.toggle("active");
            content.style.display = content.style.display === "none" ? "block" : "none";
          };
        });
      }

      // Modify renderSectionWithProgress to add shopping cart icon
      function renderSectionWithProgress(title, items, sectionKey, onProgressChange) {
        const sectionDiv = document.createElement("div");
        sectionDiv.className = "section";

        // Section header
        const header = document.createElement("div");
        header.className = "section-header";
        header.innerHTML = `<label>${title}</label>`;
        sectionDiv.appendChild(header);

        // Items list
        const ul = document.createElement("div");
        ul.className = "checkbox-group section-items";

        // Load checked state from localStorage
        let checkedArr = JSON.parse(localStorage.getItem("checked_" + sectionKey) || "[]");
        if (!Array.isArray(checkedArr) || checkedArr.length !== items.length) {
          checkedArr = Array(items.length).fill(false);
        }

        items.forEach((item, idx) => {
          const label = document.createElement("label");
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.justifyContent = "space-between";
          // Fix: Always display correct item text
          let displayText = "";
          if (typeof item === "string") {
            displayText = item;
          } else if (item && typeof item === "object") {
            displayText = item.text || item.name || JSON.stringify(item);
          }
          label.innerHTML = `<span><input type="checkbox" data-section="${sectionKey}" data-idx="${idx}"> ${displayText}</span>
                          <button class="add-to-shopping-btn" data-item="${item}" onclick="addToShoppingList('${item}')">
                              🛒
                          </button>`;
          const checkbox = label.querySelector("input[type='checkbox']");
          checkbox.checked = checkedArr[idx];
          checkbox.onchange = function () {
            checkedArr[idx] = checkbox.checked;
            localStorage.setItem("checked_" + sectionKey, JSON.stringify(checkedArr));
            if (onProgressChange) {
              onProgressChange();
            }
          };
          ul.appendChild(label);
        });

        sectionDiv.appendChild(ul);

        // Make header clickable for collapse/expand
        header.onclick = function (e) {
          if (e.target.tagName === "INPUT") return;
          ul.style.display = ul.style.display === "none" ? "block" : "none";
        };

        return sectionDiv;
      }

      function addToShoppingList(item) {
        // Add item to the shopping list array
        shoppingList.push(item);

        // Save the updated shopping list in localStorage
        localStorage.setItem("shoppingList", JSON.stringify(shoppingList));

        // Re-render the shopping list to show the new item
        renderShoppingList();

        // Show a success toast message
        showToast("Успешно додадено во Шопинг листа");
      }

      // Logo click: clear all localStorage except theme, reload, show popup after reload
      document.getElementById("lynx-logo").addEventListener("click", function () {
        if (confirm("Do you want to reset all progress and clear the checklist?")) {
          const theme = localStorage.getItem("lynx-theme");
          localStorage.clear();
          if (theme) localStorage.setItem("lynx-theme", theme);
          sessionStorage.setItem("checklist-reset", "1");
          location.reload();
        }
      });

      // On load, show reset popup if needed
      window.addEventListener("DOMContentLoaded", function () {
        if (sessionStorage.getItem("checklist-reset")) {
          sessionStorage.removeItem("checklist-reset");
          // You can use a custom popup, but for simplicity:
          const popup = document.createElement("div");
          popup.textContent = "Checklist has been reset. You now have a blank list.";
          popup.style.position = "fixed";
          popup.style.top = "30px";
          popup.style.left = "50%";
          popup.style.transform = "translateX(-50%)";
          popup.style.background = "#23272a";
          popup.style.color = "#ffe066";
          popup.style.padding = "16px 32px";
          popup.style.borderRadius = "8px";
          popup.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
          popup.style.zIndex = "9999";
          document.body.appendChild(popup);
          setTimeout(() => popup.remove(), 3000);
        }
      });

      function showToast(message) {
        // Create a new toast element
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = message;

        // Append the toast to the body
        document.body.appendChild(toast);

        // Show the toast
        setTimeout(() => {
          toast.classList.add("show");
        }, 100); // Делумно забавување за да се избегне моментално прикажување

        // Hide the toast after 3 seconds
        setTimeout(() => {
          toast.classList.remove("show");
          // Remove the toast from the DOM after animation
          setTimeout(() => {
            toast.remove();
          }, 500); // Почекајте 500ms пред да го отстраните toast
        }, 1000); // Пораката ќе исчезне по 3 секунди
      }

      function renderInventorySectionItems(sectionId, title) {
        const groupEss = document.getElementById(sectionId + "_inventory_essential");
        const groupOpt = document.getElementById(sectionId + "_inventory_optional");
        groupEss.innerHTML = "";
        groupOpt.innerHTML = "";
        (inventorySections[title].essential || []).forEach((item, idx) => {
          const label = document.createElement("label");
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.justifyContent = "space-between";
          let displayText =
            typeof item === "object" ? item.text || item.name || JSON.stringify(item) : item;
          label.innerHTML = `<span><input type="checkbox"> ${displayText}</span>`;
          groupEss.appendChild(label);
        });
        (inventorySections[title].optional || []).forEach((item, idx) => {
          const label = document.createElement("label");
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.justifyContent = "space-between";
          let displayText =
            typeof item === "object" ? item.text || item.name || JSON.stringify(item) : item;
          label.innerHTML = `<span><input type="checkbox"> ${displayText}</span>`;
          groupOpt.appendChild(label);
        });
      }
    </script>
  </body>
</html>
